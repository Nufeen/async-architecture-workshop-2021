# Домашнее задание к курсу по асинхронной архитектуре

Игрушечный проект, реализует набор сервисов, асинхронно взаимодействующих через очередь

#### Note

Что сознательно упрощено относительно изначального задания:

- Оставляем одну базу на всех, таким образом избегаем имплементации всех CUD-событий, реализуем только BE
- цену тасков задаём в момент создания, оставляем в таблице с тасками
- авторизация через api gateway + jwt. Oauth в хаскеле -- отдельная тема для исследования
- не делаем аналитику

#### Текущее состояние:

- auth -> запись в базу шифрованых паролей + валидация готовы, токены нет
- gateway -> концептуально понятно как делать, 1 тестовый маршрут
- task service -> функционально готов (требует рефактора)
- accounting -> чистый бойлерплейт, не готово ничего
- kafka -> ok
- docker-compose (локальная развертка кластера) -> не работает

## Проектирование

[Разбор требований](docs/requirments.md)

[Event flows](docs/events.md)

[Разбивка по сервисам/доменам](docs/services.md)

## Взаимодействие сервисов

Синхронные взаимодействия показаны на диаграмме. Асинхронные описаны в доке с [Event flows](docs/events.md).

```
                                                              DB
┌───────────────┐           ┌──────────────────────┐          ┌──────────────────┐
│               │           │                      │          │                  │
│               │           │                      │          │      tasks       │
│               ├───────────►  task board service  ├──────────►                  │
│               │           │                      │          └──────────────────┘
│               │           │                      │
│               │           └──────────────────────┘          ┌──────────────────┐
│  API GATEWAY  │                                             │                  │
│               ├─────────────────────────────────────────────►      users       │
│ auth  service │                                             │                  │
│               │           ┌──────────────────────┐          └──────────────────┘
│               │           │                      │
│               │           │                      │          ┌──────────────────┐
│               ├───────────►  accounting service  ├──────────►                  │
│               │           │                      │          │   transactions   │
│               │           │                      │          │                  │
└───────────────┘           └──────────────────────┘          └──────────────────┘
```

Для простоты оставляем одну базу с 3 таблицами, в которую ходят все сервисы.
Каждый сервис читает из любой таблицы, пишет только в свою.

В рамках курса предлагалось сделать несколько сервисов с отдельными базами, которые посылают события об изменениях данных и дописывают необходимый сабсет в свою базу каждый, упрощено из-за нехватки времени. В системах с очередями так не принято, это называют database integration antipattern [1](https://martinfowler.com/bliki/IntegrationDatabase.html), но всё неоднозначно [2](https://microservices.io/patterns/data/shared-database.html)

#### Доки сервисов:

[Auth service](auth-service/readme.md)

[Task service](task-service/readme.md)

[TODO: Accounting service]()

[Kafka](kafka/readme.md)

## Локальный запуск

Развернуть дамп: `psql workshopdb < ./dump.sql`: https://www.postgresql.org/docs/13/backup-dump.html

Поднять кафку: docker-compose up в папке кафки, создать топик tasks

Запустить сервисы: компоуз не готов, пока только если установлен nix командами из makefile
